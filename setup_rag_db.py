import io
import pandas as pd
import psycopg2
from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT
from pgvector.psycopg2 import register_vector
from sentence_transformers import SentenceTransformer
import sys
import time

# --- [í•µì‹¬] 1. DB ì—°ê²° ì„¤ì • (5433 í¬íŠ¸ë¡œ ë³€ê²½) ---
DB_CONFIG = {
    "dbname": "chatdb",
    "user": "user",
    "password": "1234",
    "host": "localhost",
    "port": "5433"  # <--- docker-composeì˜ 5433 í¬íŠ¸ì™€ ì¼ì¹˜!
}

MODEL_NAME = 'paraphrase-multilingual-MiniLM-L12-v2'
VECTOR_DIMENSION = 384 

# (ë°ì´í„°ëŠ” ë„ˆë¬´ ê¸°ë‹ˆê¹Œ ìƒëµ, ìœ„ì™€ ë™ì¼í•˜ê²Œ ë“¤ì–´ê°‘ë‹ˆë‹¤)
csv_data = """name,category,target ,benefit,grade_criteria,other_criteria,source_page
ì• ì²œì¥í•™ê¸ˆí•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ,,ì‹ ì…ìƒ,"4ë…„ê°„ ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) ì „ì•¡ë©´ì œ ë° ê¸°ìˆ™ì‚¬ë¹„(4ì¸ 1ì‹¤ ê¸ˆì•¡ê¸°ì¤€, ì‹ë¹„ ì œì™¸) ë©´ì œ","3.5 ì´ìƒ, ëŒ€í•™ìˆ˜í•™ëŠ¥ë ¥ì‹œí—˜ ì„±ì  3ê°œ ì˜ì—­(êµ­ì–´, ìˆ˜í•™, ì˜ì–´) ì¤‘ ì˜ì–´ ì˜ì—­ 1ë“±ê¸‰(í•„ìˆ˜), êµ­ì–´ ë˜ëŠ” ìˆ˜í•™ ì˜ì—­ì´ 2ë“±ê¸‰ ì´ë‚´ì¸ì",,
ì• ì¸ì¥í•™ê¸ˆ,í•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ,ì‹ ì…ìƒ,2ë…„ê°„ ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) ë°˜ì•¡,3.5 ì´ìƒ,ìˆ˜ì‹œ ëª¨ì§‘ ì¼ë°˜ì „í˜• ì „ì²´ ì§€ì›ì ì¤‘ ì´ 8ëª…,
ì• êµ­ì¥í•™ê¸ˆ,í•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ,ì‹ ì…ìƒ,2ë…„ê°„ ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) ë°˜ì•¡,3.5 ì´ìƒ,ìˆ˜ì‹œ ëª¨ì§‘ì ì¤‘ ì§€ì—­í•™ìƒì „í˜•ì—ì„œ ì„±ì  ìš°ìˆ˜ì,]ì§€ì—­í•™ìƒì „í˜• ì „ì²´ì§€ì›ì ì¤‘ ìƒìœ„ 3ëª…
ì§€ì—­ì¸ì¬ì¥í•™ê¸ˆ (êµë‚´),í•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ,ì‹ ì…ìƒ,1ë…„ê°„ ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) ë°˜ì•¡,3.5 ì´ìƒ,ìˆ˜ì‹œëª¨ì§‘ì ì¤‘ ì„œë¥˜ì „í˜• ìƒìœ„ 2ëª…,ë©´ì ‘ì „í˜• ìƒìœ„ 2ëª…
ì„ ë¬¸ì¸ì¬ì¥í•™ê¸ˆ,í•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ,ì‹ ì…ìƒ,1ë…„ê°„ ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) ë°˜ì•¡,3.5 ì´ìƒ,ìˆ˜ì‹œ ìµœì´ˆí•©ê²©ì ì¤‘ ì¼ë°˜í•™ìƒì „í˜•ì˜ í•™ê³¼ë³„ ì…í•™ì„±ì  ìƒìœ„ 20% ì „ì›,
ìˆ˜ì‹œì„±ì ìš°ìˆ˜ì¥í•™ê¸ˆ,í•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ,ì‹ ì…ìƒ,ì…í•™ ì²« í•™ê¸° 1íšŒ ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) 100ë§Œì› ê°ë©´,3.5 ì´ìƒ,ì§€ì—­í•™ìƒì „í˜• ì§€ì›ì ì¤‘ ì…í•™ì„±ì  ìƒìœ„ 10% ì „ì›,
ì™¸êµ­ì¸ìš°ìˆ˜ì…í•™ì¥í•™ê¸ˆ,í•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ,ì‹ ì…ìƒ (ì™¸êµ­ì¸),"í•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ, ì‹ ì…ìƒ (ì™¸êµ­ì¸), (ì–´í•™ì—°ìˆ˜) 1ë…„ê°„ í•œêµ­ì–´êµìœ¡ì› ìˆ˜ê°•ë£Œ ì „ì•¡, (í•™ë¶€ê³¼ì •) 4ë…„ê°„ ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) ì „ì•¡",3.5 ì´ìƒ,UNíšŒì›êµ­ ìš°ìˆ˜ì¥í•™ìƒ (í•´ë‹¹êµ­ê°€ ê³ êµì„±ì  ìƒìœ„ 10%ì´ë‚´ ë“±),
ë³µì§€ì¥í•™ê¸ˆ (êµë‚´),ê°€ì •í˜•í¸ ì¥í•™ê¸ˆ,ì‹ ì…ìƒ/ì¬í•™ìƒ,í•™ê¸° ë° ì†Œë“êµ¬ê°„ë³„ ê¸ˆì•¡ë³€ë™,1.6 ì´ìƒ,"í’ˆí–‰ì´ ë‹¨ì •í•˜ê³  ê°€ì •í˜•í¸ì´ ì–´ë ¤ìš´ ì, ì§ì „ í•™ê¸° 12í•™ì  ì´ìƒ ì´ìˆ˜",ë“±ë¡ê¸ˆ ë²”ìœ„ ë‚´ ì¤‘ë³µìˆ˜í˜œ ê°€ëŠ¥
ì™¸êµ­ì¸ìœ í•™ìƒì¥í•™ê¸ˆ (ì‹ ì…ìƒ),ê¸°íƒ€ ì¥í•™ê¸ˆ (ì™¸êµ­ì¸),ì‹ ì…ìƒ (ì™¸êµ­ì¸),TOPIK ê¸‰ìˆ˜ë³„ ì°¨ë“±ì§€ì› (3ê¸‰ 50% ~ 6ê¸‰ 100%),TOPIK ì™¸ ì˜ì–´ëŠ¥ë ¥ ì…í•™ì 50%,í•œêµ­ì–´ëŠ¥ë ¥ì‹œí—˜ 3ê¸‰ ì´ìƒ ì†Œì§€ì ë“±,(ë‹¤ìŒ í•™ê¸°ë¶€í„° ì ìš©)
ì™¸êµ­ì¸ìœ í•™ìƒì¥í•™ê¸ˆ (ì¬í•™ìƒ),ê¸°íƒ€ ì¥í•™ê¸ˆ (ì™¸êµ­ì¸),ì¬í•™ìƒ (ì™¸êµ­ì¸),ì§ì „í•™ê¸° í‰ì í‰ê· ì— ë”°ë¼ ì°¨ë“± ì§€ì› (2.0ë¯¸ë§Œ 0% ~ 4.2ì´ìƒ 100%),2.0 ì´ìƒ,ì§ì „í•™ê¸° ì´ìˆ˜í•™ì  ê¸°ì¤€ ì¶©ì¡± (í•™ë…„ë³„ 12~15í•™ì  ì´ìƒ),
í•´ì™¸ìë§¤í•™êµìš°í˜¸ì¥í•™ê¸ˆ,ê¸°íƒ€ ì¥í•™ê¸ˆ (ì™¸êµ­ì¸),ì‹ Â·í¸ì…ìƒ (ì™¸êµ­ì¸),"ì…í•™ ì²« í•™ê¸°(1íšŒ) ë“±ë¡ê¸ˆê³¼ ê¸°ìˆ™ì‚¬ë¹„(4ì¸ 1ì‹¤ ê¸°ì¤€, ì‹ë¹„ í¬í•¨) ë©´ì œ",(ì„±ì ê¸°ì¤€ ì—†ìŒ),ë³¸êµì™€ í˜‘ì •ì„ ì²´ê²°í•œ í•´ì™¸ìë§¤í•™êµì—ì„œ ë™ì‹œì— 10ëª… ì´ìƒ ì‹ Â·í¸ì…í•™ ì‹œ ìµœìš°ìˆ˜í•™ìƒ 1ëª…,
ì •ë¶€ì´ˆì²­ì¥í•™ê¸ˆ (GKS),ê¸°íƒ€ ì¥í•™ê¸ˆ (ì™¸êµ­ì¸),ì‹ Â·í¸ì…ìƒ (ì™¸êµ­ì¸),"ë“±ë¡ê¸ˆ ì „ì•¡, ìƒí™œë¹„(ì›” 90~120ë§Œì›), ì—°êµ¬ë¹„ ë“±",(êµ­ë¦½êµ­ì œêµìœ¡ì› ì§€ì¹¨),(ì™¸êµ­ì¸) êµ­ë¦½êµ­ì œêµìœ¡ì›ì—ì„œ ìµœì¢… ì„ ë°œëœ ì (GKS),
ê³µì§ì¥í•™ê¸ˆ,ê¸°íƒ€ ì¥í•™ê¸ˆ,ì‹ ì…ìƒ/ì¬í•™ìƒ,"ì‹ ì…ìƒ ë“±ë¡ê¸ˆ ë°˜ì•¡, ì¬í•™ìƒ (3.5ì´ìƒ) ë°˜ì•¡, (3.0~3.5) 1/4 ê°ë©´",3.0 ì´ìƒ,ì‹ í•™ê³¼ ì¬í•™ìƒìœ¼ë¡œì„œ ì¡¸ì—… í›„ ê³µì§ì— 1ë…„ ì´ìƒ ì°¸ì—¬í•  í•™ìƒ,
ë³´í›ˆì¥í•™ê¸ˆ,ê¸°íƒ€ ì¥í•™ê¸ˆ,ì‹ ì…ìƒ/ì¬í•™ìƒ,"ë“±ë¡ê¸ˆ ì „ì•¡ ë©´ì œ (ë³¸ì¸ ì„±ì ë¬´ê´€, ìë…€ 1.6ì´ìƒ)",1.6 ì´ìƒ,ë³´í›ˆëŒ€ìƒì ë³¸ì¸ ë˜ëŠ” ì§ê³„ìë…€(ë…ë¦½ìœ ê³µìëŠ” ì†Â·ìë…€ê¹Œì§€),
ìƒˆí„°ë¯¼ì¥í•™ê¸ˆ,ê¸°íƒ€ ì¥í•™ê¸ˆ,ì‹ ì…ìƒ/ì¬í•™ìƒ,"ë“±ë¡ê¸ˆ ì „ì•¡ ë©´ì œ (í†µì¼ë¶€ êµ­ê³  50%, êµë‚´ 50%)",1.6 ì´ìƒ,ë¶í•œì´íƒˆì£¼ë¯¼ êµìœ¡ì§€ì›ìœ¼ë¡œì¨ ë³¸êµì— ì…í•™í•œ ì,
êµì§ì›ì§ê³„ìë…€ì¥í•™ê¸ˆ,ê¸°íƒ€ ì¥í•™ê¸ˆ,ì‹ ì…ìƒ/ì¬í•™ìƒ,ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) ì „ì•¡,2.5 ì´ìƒ,ë³¸ ëŒ€í•™êµ êµì§ì› ìë…€.,ì§ì „ í•™ê¸° 15í•™ì  ì´ìƒ ì´ìˆ˜
í¸ì…í•™ì¥í•™ê¸ˆ (ë‚´êµ­ì¸),í¸ì…í•™ ì¥í•™ê¸ˆ,í¸ì…ìƒ (ë‚´êµ­ì¸),"ì…í•™í•™ê¸° ì¥í•™ê¸ˆ(200ë§Œì›) ë° ê¸°ìˆ™ì‚¬ë¹„(3ì¸ 1ì‹¤, ì‹ë¹„ì œì™¸) ë©´ì œ (ì…í•™í•™ê¸°)",(ì„±ì ê¸°ì¤€ ì—†ìŒ),ë³¸êµì— í¸ì…í•œ ë‚´êµ­ì¸í•™ìƒ,
í¸ì…í•™ì¥ë ¤ê¸ˆ,í¸ì…í•™ ì¥í•™ê¸ˆ,í¸ì…ìƒ,ì „ë¬¸ëŒ€ ì§€ë„êµìˆ˜ ì¶”ì²œì‹œ ì¥í•™ê¸ˆ(100ë§Œì›) ì¶”ê°€,(ì„±ì ê¸°ì¤€ ì—†ìŒ),ë³¸êµ ì…í•™ì ì „ì› (í¸ì…ìƒ),
í¬ë§ë‚˜ëˆ”ì¥í•™ê¸ˆ,ê¸°íƒ€ ì¥í•™ê¸ˆ,ì‹ ì…ìƒ/ì¬í•™ìƒ,ë§¤ë…„ ì¼ì •ì•¡ì˜ ë“±ë¡ê¸ˆ ê°ë©´ ë˜ëŠ” ì¥í•™ê¸ˆ ì§€ê¸‰ (ì˜ˆì‚°ë²”ìœ„ ë‚´),(ì„±ì ê¸°ì¤€ ì—†ìŒ),ì¥ì• ì¸ë³µì§€ë²• ì œ2ì¡°ì— ë”°ë¼ ì¥ì• ì¸(1ê¸‰~6ê¸‰)ìœ¼ë¡œ ë“±ë¡ëœ í•™ìƒ,
ê¸°íšŒê· í˜•ì¥í•™ê¸ˆ (ìƒí™œë¹„),í•™ì—…(ì…í•™) ì„±ì  ì¥í•™ê¸ˆ,ì‹ ì…ìƒ,ì •ê·œí•™ê¸°(8í•™ê¸°) ìƒí™œë¹„ 100ë§Œì› ì§€ê¸‰,3.5 ì´ìƒ,ìˆ˜ì‹œ ëª¨ì§‘ì ì¤‘ ì„±ì  ìš°ìˆ˜ì.,ì´ 6ëª…
ìˆ˜ì„ (ì¬í•™ìƒ),í•™ì—… ì„±ì  ì¥í•™ê¸ˆ,ì¬í•™ìƒ,ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ)ì˜ 70% ê°ë©´,4.0 ì´ìƒ,ì§ì „ í•™ê¸° ì„±ì  4.0ì  ì´ìƒì¸ ì ì¤‘ í•™ë¶€(ì „ê³µ)/í•™ë…„ë³„ ì„±ì ìˆœ,
ì°¨ì„ (ì¬í•™ìƒ),í•™ì—… ì„±ì  ì¥í•™ê¸ˆ,ì¬í•™ìƒ,ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ)ì˜ 50% ê°ë©´,3.8 ì´ìƒ,ì§ì „ í•™ê¸° ì„±ì  3.8ì  ì´ìƒì¸ ì ì¤‘ í•™ë¶€(ì „ê³µ)/í•™ë…„ë³„ ì„±ì ìˆœ,
ìš°ìˆ˜ (ì¬í•™ìƒ),í•™ì—… ì„±ì  ì¥í•™ê¸ˆ,ì¬í•™ìƒ,ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ)ì˜ 15% ê°ë©´,3.8 ì´ìƒ,ì§ì „ í•™ê¸° ì„±ì  3.8ì  ì´ìƒì¸ ì ì¤‘ í•™ë¶€(ì „ê³µ)/í•™ë…„ë³„ ì„±ì ìˆœ,
ê°€ì‚¬ì¥í•™ê¸ˆ,ê°€ì •í˜•í¸ ì¥í•™ê¸ˆ,ì¬í•™ìƒ,1ë…„ì— 1íšŒ 1ëª…ì—ê²Œ ë“±ë¡ê¸ˆ(ìˆ˜ì—…ë£Œ) ì „ì•¡,1.6 ì´ìƒ,ì§ê³„ìë…€ 3ì¸ ì´ìƒì´ ë³¸êµì— ì¬í•™ ì¤‘ì¸ ê²½ìš°,
ê°€ì¡±ì¥í•™ê¸ˆ (ìƒí™œë¹„),ê°€ì •í˜•í¸ ì¥í•™ê¸ˆ,ì¬í•™ìƒ,1ë…„ì— 1íšŒ 1ëª…ì—ê²Œ ì¼ì •ì•¡,(ì„±ì ê¸°ì¤€ ì—†ìŒ),"í˜•ì œ, ìë§¤, ë‚¨ë§¤ ë˜ëŠ” ì§ê³„ì¡´ì† ê°€ì¡± 1ì¸ì´ í•¨ê»˜ ì¬í•™ ì¤‘ì¸ ì",
í–‰ì •ì—°ìˆ˜ì¥í•™ê¸ˆ (ìƒí™œë¹„),ê·¼ë¡œ ì¥í•™ê¸ˆ,ì¬í•™ìƒ,"í•œ í•™ê¸° (ë‹¨ê¸° ê·¼ë¡œ 80ì‹œê°„, ìµœì €ì‹œê¸‰)",(ì„±ì ê¸°ì¤€ ì—†ìŒ),í’ˆí–‰ì´ ë‹¨ì •í•˜ê³  ê°€ì •í˜•í¸ì´ ì–´ë ¤ìš´ ì ì¤‘ì—ì„œ ë‹¨ê³¼ëŒ€í•™ì¥ ë° ë¶€ì„œì¥ì˜ ì¶”ì²œì„ ë°›ì€ ì,
í•´ì™¸ì—°ìˆ˜ì¥í•™ê¸ˆ (ìƒí™œë¹„),í•´ì™¸ ì—°ìˆ˜ ì¥í•™ê¸ˆ,ì¬í•™ìƒ,ê°œë³„ ë¶€ì„œ ë° í”„ë¡œê·¸ë¨ ë³„ë„ ê·œì • ì˜ê±° ì§€ê¸‰,(ë³„ë„ ê·œì •),ì™¸êµ­ì˜ ëŒ€í•™ì—ì„œ í•™ì ì„ ì¸ì •ë°›ëŠ” êµê³¼ê³¼ì •ì„ ì´ìˆ˜í•˜ê³ ì í•˜ëŠ” í•™ìƒ (ì„ ë¬¸ ê¸€ë¡œë²ŒFLYì œë„),
êµ­ê°€ì¥í•™ê¸ˆ Iìœ í˜•,êµ­ê°€,ì‹ ì…ìƒ/ì¬í•™ìƒ,ì†Œë“ë¶„ìœ„ë³„ ì°¨ë“± ì§€ì› (ê¸°ì´ˆÂ·ì°¨ìƒìœ„ ì „ì•¡ ~ 9êµ¬ê°„ 50ë§Œì›),2.60(80ì ) ì´ìƒ,ì†Œë“ 9êµ¬ê°„ ì´í•˜,ì§ì „í•™ê¸° 12í•™ì  ì´ìˆ˜ (ì‹ ì…ìƒ ì²«í•™ê¸° ë¯¸ì ìš©)
êµ­ê°€ì¥í•™ê¸ˆ IIìœ í˜•,êµ­ê°€,ì‹ ì…ìƒ/ì¬í•™ìƒ,ì„ ë¬¸ëŒ€ ë³µì§€ ì¥í•™ê¸ˆìœ¼ë¡œ ì—°ê³„ë˜ì–´ ì¶”ê°€ ì§€ì› (ê¸°ì´ˆÂ·ì°¨ìƒìœ„ 140ë§Œì› ~ 5êµ¬ê°„ 120ë§Œì›),2.60(80ì ) ì´ìƒ,êµ­ê°€ì¥í•™ê¸ˆ Iìœ í˜• ìˆ˜í˜œì ì¤‘ ì†Œë“ 0~5êµ¬ê°„ (Cí•™ì  ê²½ê³ ì œ ì‹œ ìˆ˜í˜œ ë¶ˆê°€),
ë‹¤ìë…€ êµ­ê°€ì¥í•™ê¸ˆ,êµ­ê°€,ì‹ ì…ìƒ/ì¬í•™ìƒ,"ì†Œë“ë¶„ìœ„ë³„ ì°¨ë“± ì§€ì› (ì…‹ì§¸ ì´ìƒ 0~8êµ¬ê°„ ì „ì•¡, ì²«ì§¸/ë‘˜ì§¸ 1~9êµ¬ê°„ ì°¨ë“±)",2.60(80ì ) ì´ìƒ,ë‹¤ìë…€ ê°€êµ¬(ìë…€ 3ëª… ì´ìƒ)ì˜ ëª¨ë“  ìë…€. ì†Œë“ 9êµ¬ê°„ ì´í•˜,ì§ì „í•™ê¸° 12í•™ì  ì´ìˆ˜
ì§€ì—­ì¸ì¬ì¥í•™ê¸ˆ (êµ­ê°€),êµ­ê°€,ì‹ ì…ìƒ,ë“±ë¡ê¸ˆ ì „ì•¡ (ì†Œë“êµ¬ê°„ ë”°ë¼ 4ë…„/1ë…„ ì§€ì›),2.60(80ì ) ì´ìƒ (ê³„ì†ì§€ì›),(ë‚´ì‹ ) ê³ êµì„ì°¨ 3ë“±ê¸‰ ì´ë‚´ ë˜ëŠ” (ìˆ˜ëŠ¥) 2ê°œ ì˜ì—­ ì´ìƒ 3ë“±ê¸‰ ì´ë‚´.,2018~2025ë…„ ì…í•™ì
êµ­ê°€ê·¼ë¡œì¥í•™ê¸ˆ (ìƒí™œë¹„),êµ­ê°€,ì¬í•™ìƒ,"êµë‚´ê·¼ë¡œ ì‹œê¸‰ 10,030ì›, êµì™¸ê·¼ë¡œ ì‹œê¸‰ 12,430ì›",1.60(70ì ) ì´ìƒ,ì†Œë“ 9êµ¬ê°„ ì´í•˜,ì§ì „ í•™ê¸° ì„±ì  70ì  ì´ìƒì¸ ê²½ì œì  ê°€ê³„ ê³¤ë€ì
êµ­ê°€ìš°ìˆ˜ì¥í•™ê¸ˆ (ì´ê³µê³„),êµ­ê°€,ì‹ ì…ìƒ,ë“±ë¡ê¸ˆ ì „ì•¡ (ê³„ì†ì§€ì› ê¸°ì¤€ ì¶©ì¡± ì‹œ),3.6(90ì ) ì´ìƒ (ê³„ì†ì§€ì›),êµ­ë‚´ 4ë…„ì œ ëŒ€í•™ ìì—°ê³¼í•™ ë° ê³µí•™ê³„ì—´ í•™ê³¼ ì‹ ì…ìƒ ì¤‘ ì„±ì /ìˆ˜ëŠ¥ ê¸°ì¤€ ì¶©ì¡±ì,
"""

def get_db_connection(config, dbname=None):
    try:
        conn_config = config.copy()
        if dbname:
            conn_config["dbname"] = dbname
        print(f"ğŸ”Œ DB ì—°ê²° ì‹œë„ ì¤‘... (Host: {conn_config['host']}, Port: {conn_config['port']}, DB: {conn_config['dbname']})")
        conn = psycopg2.connect(**conn_config)
        print("âœ… DB ì—°ê²° ì„±ê³µ!")
        return conn
    except Exception as e:
        print(f"âŒ DB ì—°ê²° ì‹¤íŒ¨: {e}")
        return None

def setup_database(config):
    print("\n1ï¸âƒ£ [DB ì„¤ì • ì‹œì‘] í…Œì´ë¸” ìƒì„± ì¤€ë¹„ ì¤‘...")
    conn = get_db_connection(config)
    if not conn: return

    conn.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)
    with conn.cursor() as cur:
        # pgvector í™•ì¥
        cur.execute("CREATE EXTENSION IF NOT EXISTS vector")
        # í…Œì´ë¸” ì´ˆê¸°í™”
        cur.execute("DROP TABLE IF EXISTS scholarships")
        cur.execute(f"""
        CREATE TABLE scholarships (
            id SERIAL PRIMARY KEY,
            name TEXT,
            category TEXT,
            target TEXT,
            benefit TEXT,
            grade_criteria TEXT,
            other_criteria TEXT,
            combined_content TEXT,
            embedding vector({VECTOR_DIMENSION})
        )
        """)
        # ì¸ë±ìŠ¤ ìƒì„±
        cur.execute(f"CREATE INDEX ON scholarships USING HNSW (embedding vector_l2_ops)")
        print("âœ… [ì™„ë£Œ] 'scholarships' í…Œì´ë¸” ìƒì„± ì™„ë£Œ.")
    
    conn.commit()
    conn.close()

def load_and_embed_data(config):
    print("\n2ï¸âƒ£ [ë°ì´í„° ì €ì¥ ì‹œì‘] ì„ë² ë”© ëª¨ë¸ ë¡œë”© ì¤‘...")
    model = SentenceTransformer(MODEL_NAME)
    
    df = pd.read_csv(io.StringIO(csv_data)).fillna('')
    conn = get_db_connection(config)
    register_vector(conn)
    
    with conn.cursor() as cur:
        for i, row in df.iterrows():
            combined_content = f"ì¥í•™ê¸ˆëª…: {row['name']} ...".strip() # (ì¤„ì„)
            embedding = model.encode(combined_content)
            
            cur.execute(
                """
                INSERT INTO scholarships 
                (name, category, target, benefit, grade_criteria, other_criteria, combined_content, embedding)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                """,
                (row['name'], row['category'], row['target '], row['benefit'], 
                 row['grade_criteria'], row['other_criteria'], combined_content, embedding)
            )
            if i % 5 == 0: print(f"   >> ì§„í–‰ ì¤‘: {i+1}/{len(df)}")
            
    conn.commit()
    conn.close()
    print(f"âœ… [ì™„ë£Œ] ì´ {len(df)}ê°œ ë°ì´í„° ì €ì¥ ì™„ë£Œ.")

def verify_table_exists(config):
    print("\n3ï¸âƒ£ [ìµœì¢… í™•ì¸] DBì— ë°ì´í„°ê°€ ì§„ì§œ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤...")
    conn = get_db_connection(config)
    with conn.cursor() as cur:
        # í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        cur.execute("SELECT to_regclass('public.scholarships');")
        if cur.fetchone()[0]:
            print("   -> í…Œì´ë¸” 'scholarships' ì¡´ì¬í•¨: O")
        else:
            print("   -> âŒ í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤! ë­”ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.")
            return

        # ë°ì´í„° ê°œìˆ˜ í™•ì¸
        cur.execute("SELECT count(*) FROM scholarships;")
        count = cur.fetchone()[0]
        print(f"   -> ì €ì¥ëœ ë°ì´í„° ê°œìˆ˜: {count}ê°œ")
        
        if count > 0:
            print("ğŸ‰ [ì„±ê³µ] ëª¨ë“  ê³¼ì •ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        else:
            print("âš ï¸ [ê²½ê³ ] í…Œì´ë¸”ì€ ìˆëŠ”ë° ë°ì´í„°ê°€ 0ê°œì…ë‹ˆë‹¤.")
    conn.close()

if __name__ == "__main__":
    print("ğŸš€ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì„ ì‹œì‘í•©ë‹ˆë‹¤!")
    setup_database(DB_CONFIG)
    load_and_embed_data(DB_CONFIG)
    verify_table_exists(DB_CONFIG)